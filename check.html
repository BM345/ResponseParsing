<!DOCTYPE html>
<html>

<head>

    <link href="style.css" type="text/css" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>

    <script type="text/javascript" src="http://www.physicsformulae.com/2dgraphicsjs/maths.js"></script>
    <script type="text/javascript" src="http://www.physicsformulae.com/2dgraphicsjs/graphics.js"></script>
    <script type="text/javascript" src="http://www.physicsformulae.com/2dgraphicsjs/application.js"></script>

    <script type="text/javascript" src="rpnodes.js"></script>
    <script type="text/javascript" src="responseparsing.js"></script>

    <script type="text/javascript">

        class App extends Application {
            constructor(canvasId) {
                super(canvasId);

                this.nodeTree = null;
            }

            setNodeTree(nodeTree) {
                this.nodeTree = nodeTree;

                if (this.nodeTree !== null) {
                    this.nodeTree.position = v2(2000, 400);
                    this.setSubnodePositions(this.nodeTree);
                }
            }

            setSubnodePositions(node) {
                var m = node.subnodes.length;
                var a1 = 45;
                var a2 = 135;
                var da = (a2 - a1) / (m - 1);
                var a = a1;
                var u1 = v2(-1, 0);

                node.subnodes.forEach(n => {
                    n.position = node.position.add(u1.rotate(-a).times(600));
                    this.setSubnodePositions(n);
                    a += da;
                });
            }

            drawNode(graphics, node) {
                var fs1 = 90;
                var fs2 = 70;
                var fn1 = "Didot";
                var fn2 = "Courier New";

                var size1 = graphics.measureText(node.title, fn1, fs1);
                var size2 = graphics.measureText(node.asciiMath, fn2, fs2);

                var w1 = size1.width / 2 + 100;
                var h1 = fs1 / 2 + fs2 / 2 + 70;

                var e1 = node.position.translate(-w1, -h1);
                var e2 = node.position.translate(w1, -h1);
                var e3 = node.position.translate(w1, h1);
                var e4 = node.position.translate(-w1, h1);

                if (node.supernode != null) {
                    var e5 = node.supernode.position.translate(0, h1);
                    var e6 = node.position.translate(0, -h1);
                    graphics.drawLine(e5, e6, "#404040");
                }

                var e7 = node.position.translate(0, -fs2 / 2 - 20);
                var e8 = node.position.translate(0, fs2 / 2 + 20);

                graphics.drawPath([e1, e2, e3, e4, e1], "white", "#404040");
                graphics.drawText(node.title, e7, "middlecentre", 0, fn1, fs1, "#202020");
                graphics.drawText(node.asciiMath, e8, "middlecentre", 0, fn2, fs2, "#A0A0A0");

                node.subnodes.forEach(n => this.drawNode(graphics, n));
            }

            draw() {
                var graphics = new GraphicsContext(this.context);

                graphics.clear(4000, 2000);

                if (this.nodeTree !== null) {
                    this.drawNode(graphics, this.nodeTree);
                }
            }
        }

        var app = new App("nodeTreeCanvas");

        var rp = new ResponseParser();

        window.addEventListener("load", function () {

            var input = document.getElementById("input1");
            var output = document.getElementById("output1");
            var katexOutput = document.getElementById("katexOutput1");

            input.onkeyup = function (e) {
                var parseResult = rp.getParseResult(input.value.toString());

                app.setNodeTree(parseResult);

                var cache = [];
                output.innerText = JSON.stringify(parseResult, function (key, value) {
                    if (typeof value === "object" && value !== null) {
                        if (cache.indexOf(value) !== -1) {
                            return;
                        }
                        cache.push(value);
                    }
                    return value;
                }, 4);
                cache = null;

                if (parseResult !== null) {
                    katex.render(parseResult.latex, katexOutput);
                }
                else {
                    katex.render("", katexOutput);
                }

            }

        });

    </script>

    <script type="text/javascript" src="tests.js"></script>

</head>

<body>

    <div class="mainbox">
        <input type="text" id="input1" />
        <div class="katexOutput" id="katexOutput1" style="text-align: center;"></div>
        <canvas id="nodeTreeCanvas" style="width: 1000px; height: 500px; display: block; margin: 20px auto;"></canvas>
        <pre style="display: none;"><code id="output1"></code></pre>
    </div>

</body>

</html>